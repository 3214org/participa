<% content_for :title, t("podemos.impulsa.title") %>

<div class="content-content cols">
  <div class="row">
    <div class="col-b-4a12">

      <%= render partial: "steps", locals: {project: @project, step: @step} %>
      <%= content_tag(:h2, t("podemos.impulsa.title") + " - " + @project.wizard_step_info[:title]) %>
      <% info = if @project.saveable? then
          content_tag(:p, t("podemos.impulsa.fixes_text")) if @project.fixes?
        else
          if @project.spam?
            content_tag(:p, t("podemos.impulsa.spam_text"))
          elsif @project.validable?
            content_tag(:p, t("podemos.impulsa.validable_text"))
          elsif @project.invalidated?
            content_tag(:p, t("podemos.impulsa.invalidated_text", invalid_reasons: @project.evaluator2_invalid_reasons))
          elsif @project.validated?
            if @project.impulsa_edition_category.needs_preselection?
              content_tag(:p, t("podemos.impulsa.validated1_text", voting_dates: @project.voting_dates, winners: @project.impulsa_edition_category.winners, prewinners: @project.impulsa_edition_category.prewinners))
            else
              content_tag(:p, t("podemos.impulsa.validated2_text", voting_dates: @project.voting_dates))
            end
          elsif @project.fixes?
            content_tag(:p, t("podemos.impulsa.non_fixes_text"))
          else
            content_tag(:p, t("podemos.impulsa.reviewing_text"))
          end
        end %>

      <%= info_box do %>
        <%= info %>
      <% end if info %>

      <%= semantic_form_for @project, url: update_step_impulsa_path(step: @step), html: {method: :post, autocomplete: 'off'} do |f| %>
        <%= simple_format(@project.wizard_step_info[:text]) if @project.wizard_step_info[:text].present? %>
        <% @project.wizard_step_info[:groups].each do |gname, group|
          next if !@project.wizard_eval_condition(group) %>
          <fieldset>
            <% if group[:title].present? %><h3><%=group[:title]%></h3><% end %>
            <%= simple_format(group[:text]) if group[:text].present? %>
            <% group[:fields].each do |fname, field|
                key = "#{gname}.#{fname}"
                field_name = :"_wiz_#{gname}__#{fname}"
                value = @project.send(field_name) # TO-DO: this force to call missing_method, Formtastic use don't work with arrays (check_boxes) 
              %>
                <div class="inputlabel-box impulsa">
                  <% if @project.errors.include?(field_name) %>
                    <%= field_notice_box %>
                  <% end %>
                  <% if field[:type]=="file" %>
                    <%= f.input field_name, label: field[:title], as: :file, input_html: {class: 'input-xl', accept: filetypes_to_file_filter(field[:filetype]), "data-url"=>upload_impulsa_path(field: key)} %>
                    <div class="file form-group file-data">
                      <span class="form-label"><label><%= link_to(fa_icon("cloud-download", text: t("podemos.impulsa.model_link")), field[:template]) if field[:template] %></label></span>
                      <span class="form-wrapper">
                        <div class="progress hidden"><div class="progress-bar progress-bar-success"></div></div>
                        <div class="current-file<%=" hidden" if @project.wizard_values[key].blank?%>"> <%= link_to(@project.wizard_values[key] || "", download_impulsa_path(field: @project.wizard_values[key] || ""), class: :download)%> <%= link_to(fa_icon("trash"), delete_file_impulsa_path(field: key), method: :delete, "data-remote"=>true, "data-confirm"=>"Esto borrará el fichero. ¿Deseas continuar?", class: :delete)%></div>
                      </span>
                    </div>
                  <% elsif field[:type].in? ["select", "check_boxes"] %>
                    <%= f.input field_name, label: field[:title], as: field[:type], collection: field[:collection].to_a.map(&:reverse), input_html: {class: if field[:type]=="check_boxes" then '' else 'input-xl' end} %>
                  <% else %>
                    <%= f.input field_name, label: field[:title], as: field[:type], input_html: {class: 'input-xl'} %>
                  <% end %>
                </div>
              <%= content_tag(:p, fa_icon("asterisk", text: field[:tip], class: "fa-fw"), class: :note) if field[:tip].present? %>
            <% end %>
          </fieldset>
        <% end %>

        <% if @project.saveable? %>
          <%= f.actions class: 'enter' do %>
            <%= f.action :submit, :label=>@show_errors ? "Guardar cambios" : t("podemos.impulsa.next_step"), :as => :input, button_html: {class: 'button'} if @project.saveable? %>
            <%= link_to("Ir a resumen y " + t("podemos.impulsa.mark_for_review"), project_impulsa_path, class: 'button') unless @project.wizard_has_errors? %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
